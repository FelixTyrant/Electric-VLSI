<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="run" name="electric">

    <target name="init">
        <property name="beanshell" value="../lib/java/bsh-1.2b3.jar"/>
        <property name="AppleJava" value="packaging/AppleJavaExtensions.jar"/>
    </target>

    <target name="compile" depends="init">
        <javac debug="true" deprecation="true" destdir="." srcdir=".">
            <classpath><pathelement location="${beanshell}"/></classpath>
            <classpath><pathelement location="${AppleJava}"/></classpath>
            <exclude name="intervalsimulation/"/>
        </javac>
    </target>

    <target name="run" depends="init,compile">
        <java classname="com.sun.electric.Launcher" failonerror="true" fork="true" maxmemory="1024m">
            <classpath>
                <pathelement location="."/>
                <pathelement location="${beanshell}"/>
                <pathelement location="${AppleJava}"/>
           </classpath>
        </java>
    </target>

    <target name="runMain" depends="init,compile">
        <java classname="com.sun.electric.Main" failonerror="true" fork="true" maxmemory="256m">
            <classpath>
                <pathelement location="."/>
                <pathelement location="${beanshell}"/>
                <pathelement location="${AppleJava}"/>
           </classpath>
        </java>
    </target>

    <target name="jar" depends="init,compile" description="Make binary Jar file">
        <!-- To make a standalone app: -->
        <!-- 1. Create electric.mf manifest. -->
        <!-- 2. Put in it two lines: -->
        <!-- Manifest-Version: 1.0 -->
        <!-- Main-Class: com.sun.electric.Launcher -->
        <!-- 3. Pass to <jar>: manifest="electric.mf" -->
        <property name="version" value=""/>
        <unjar dest="." src="${beanshell}"/> 
        <unjar dest="." src="${AppleJava}"/> 
        <delete dir="META-INF"/>
        <copy file="packaging/electric.mf" tofile="electric${version}.mf"/>
        <jar basedir="." compress="true" jarfile="electric${version}.jar" manifest="electric${version}.mf">
            <exclude name="apidoc/"/>
            <exclude name="intervalsimulation/"/>
            <exclude name="packaging/"/>
            <exclude name="build.xml"/>
            <exclude name="ChangeLog.txt"/>
            <exclude name="electric${version}.jar"/>
            <exclude name="electric${version}.mf"/>
            <exclude name="Hack_stack.txt"/>
            <exclude name="**/.nbattrs"/>
            <exclude name="**/*.java"/>
            <exclude name="**/*.form"/>
        </jar>
        <delete file="electric${version}.mf"/>
        <delete dir="bsh"/>
        <delete dir="com/apple"/>
        <delete quiet="true">
            <fileset dir="com">
                <include name="**/*.class"/>
            </fileset>
        </delete>
    </target>

    <target name="jarSource" depends="init,compile" description="Make source Jar file">
        <unjar dest="." src="${beanshell}"/> 
        <unjar dest="." src="${AppleJava}"/> 
        <delete dir="META-INF"/>
        <jar basedir="." compress="true" jarfile="electric.jar" manifest="packaging/electric.mf">
            <exclude name="apidoc/"/>
            <exclude name="intervalsimulation/"/>
            <exclude name="packaging/"/>
            <exclude name="electric.jar"/>
            <exclude name="Hack_stack.txt"/>
            <exclude name="**/.nbattrs"/>
        </jar>
        <delete dir="bsh"/>
        <delete dir="com/apple"/>
    </target>

    <target name="mac-app" depends="jar">
        <property name="appdir" value="electric.app"/>
        <mkdir dir="${appdir}"/>
        <mkdir dir="${appdir}/Contents"/>
        <mkdir dir="${appdir}/Contents/MacOS"/>
        <mkdir dir="${appdir}/Contents/Resources"/>
        <mkdir dir="${appdir}/Contents/Resources/Java"/>
        <copy file="/System/Library/Frameworks/JavaVM.framework/Versions/Current/Resources/MacOS/JavaApplicationStub" todir="${appdir}/Contents/MacOS"/>
        <chmod file="${appdir}/Contents/MacOS/JavaApplicationStub" perm="755"/>
        <copy file="Info.plist" todir="${appdir}/Contents"/>
        <copy file="electric.icns" todir="${appdir}/Contents/Resources"/>
        <copy file="electric.jar" todir="${appdir}/Contents/Resources/Java"/>
        <exec command="/Developer/Tools/SetFile -a B ${appdir}"/>
    </target>

    <target name="testJar" depends="init,jar" description="Run Jar file">
        <java classname="com.sun.electric.Launcher" failonerror="true" fork="true">
            <classpath>
                <pathelement location="."/>
                <pathelement location="${beanshell}"/>
                <pathelement location="${AppleJava}"/>
           </classpath>
        </java>
    </target>

    <target name="javadoc" depends="init" description="Create Javadoc">
        <mkdir dir="apidoc"/>
        <javadoc destdir="apidoc" packagenames="com.sun.electric.*">
            <classpath>
                <pathelement location="${beanshell}"/>
                <pathelement location="${AppleJava}"/>
           </classpath>
           <sourcepath>
                <pathelement location="."/>
            </sourcepath>
        </javadoc>
    </target>

    <target name="clean" depends="init" description="Clean all build products">
        <delete quiet="true">
            <fileset dir=".">
                <include name="**/*.class"/>
            </fileset>
        </delete>
        <delete file="electric.jar"/>
        <delete dir="apidoc"/>
    </target>

</project>
